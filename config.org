#+TITLE: Emacs Configuration
#+PROPERTY: header-args:emacs-lisp :tangle yes

* TODO
- [ ] Helpful
- [ ] Setup Corfu
- [ ] Crux
- [ ] Magit
- [ ] avy
- [ ] Apheleia
- [ ] moocha
- [ ] rssfeed
this is the formatting on save

* [ ] Migrate to Emacs
** [ ] CS
** [ ] LSP
CodeActions + diagnostics shoudld be shown in a float win
(not in the sliding from down window)
*** tree sitter
and its integration to select blocks of code etc
*** Manager (like Mason)
to manage formatters, linters, lsp servers
*** Linter
like lint.nvim from neovim
*** Formatter
like conform. apply formatting on save / on command
*** Auto-completion
like nvim-cmp
*** Trouble
interactive buffer with diagnostic information.
traverse through diagnostics, fzf search like in telescope
** Git
*** Signs
Progress of the git integration should be in the column on the left
*** Integration
To have ui for dif, seeint commit history etc (neogit from nvim)
** Bars:
Configure all the lines to your likings
*** Status Bar
Specific to buffers.
Rules for filetypes (to setup a specific statuslines for trees, debug, info wins etc)
Mode, filetype, position, search & select information
*** Session Bar
Session info: list of session (like tmux)
- [ ] TODO:
  have a block to show: prev-next session. to more easily traverse
*** Tab Line
global line. tabs + Shows git brach, diagnostics
*** WinBar
info on the file and position in it (in which block of code)
** UI
*** Float terminal
toggle-able
*** Tree
on the side
*** Noice (better cmd mode)
cmd mode should appear in the middle of the screen.
auto-suggestions for searches
(suggest what can i search in the buffer as i type in)
*** Notify
better notification view + history.
*** Which-key
also support for marks (local and global), registers etc
*** Telescope
fzf search with pop-up interface. not slide-down
files, live-grep of the project (search substrings),
*** Harpoon
add buffers (files) to the list and traverse between them with hotkeys
ability to output all the files to the side-buffer (alongside with tree)
** QoL
*** Folding
*** Auto-pairs
*** Indent Blank Line
*** highlight when F/T searching
better search for f and t navigations.
highlight the next occurrence for better ";" navigation
*** Illuminate
highlihgt the currect identifier in the buffer.
traverse through it
*** [ ] Helpful
** Org
** Apps
*** Telegram
*** YouYube
*** Mail
*** Browser
*** leetCode
** Snippets
*** java
*** lua
*** c++
*** org
*** python
*** bash

* Plugin Manager
Use ~bootstrap.el~ to manage my packages
#+begin_src emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name
          "straight/repos/straight.el/bootstrap.el"
          (or (bound-and-true-p straight-base-dir)
              user-emacs-directory)))
        (bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  ;; use-package
  (straight-use-package 'use-package)
  (setq straight-use-package-by-default t)

  ;; some strange stuff idk that seems to make my config work
  (setq straight-check-for-modifications '(find-when-checking))
  (require 'org) ;; Ensure built-in Org is loaded first
  (setq straight-built-in-pseudo-packages '(org))

  ;; melpa sync or whatever
  (require 'package)
(setq package-archives
      '(("gnu"   . "https://elpa.gnu.org/packages/")
        ("nongnu". "https://elpa.nongnu.org/nongnu/")
        ("melpa" . "https://melpa.org/packages/")))

(package-initialize)

#+end_src

* General
** Global macros
#+begin_src emacs-lisp
  (defmacro keymap-set-with-desc (&rest args)
    "Bind a key in a keymap and add a which-key description.
  Keyword arguments:
    :map     -- the keymap to use
    :key     -- the key sequence 
    :command -- the command to bind (can be nil)
    :desc    -- the description (for which-key)
  "
    (let ((map     (plist-get args :map))
          (key     (plist-get args :key))
          (command (plist-get args :command))
          (desc    (plist-get args :desc)))
      `(progn
         (keymap-set ,map ,key ,command)
         (which-key-add-key-based-replacements ,key ,desc))))


  ;; save locals:
  (add-to-list 'safe-local-variable-values '(org-image-actual-width . (800)))
#+end_src
** Settings
#+begin_src emacs-lisp
  ;; ----------------------------
  ;; System Dependencies
  ;; ----------------------------
  (setq python-shell-interpreter "~/src/pyenv/global/bin/python")
  (setenv "PATH" (concat (expand-file-name "~/src/pyenv/global/bin") ":" (getenv "PATH")))
  (setq exec-path (append '("~/src/pyenv/global/bin") exec-path))
  
  ;; ----------------------------
  ;; UI Customizations
  ;; ----------------------------
  (add-to-list 'custom-theme-load-path "~/.config/emacs/themes/") 
  (menu-bar-mode 0)    ;; Disable the menu bar
  (tool-bar-mode 0)    ;; Disable the toolbar
  (scroll-bar-mode 0)  ;; Disable visible scrollbar
  (tooltip-mode 0)     ;; Disable tooltips
  (set-fringe-mode 10) ;; Give some breathing room

  (setq inhibit-startup-message t) ;; Do not show startup screen
  (setq visible-bell nil) ;; No visual bell

  ;; Load theme
  (use-package doom-themes)

  ;; ----------------------------
  ;; Line Numbers & Cursor Settings
  ;; ----------------------------

  (global-hl-line-mode 1)  ;; Highlight the current line globally
  (setq display-line-numbers-type 'visual) ;; Do not count folds
  (global-display-line-numbers-mode 1)

  (setq-default display-line-numbers-current-absolute nil) ;; Don't make the current line absolute

  (show-paren-mode 1) ;; Highlight matching parentheses
  (global-visual-line-mode 1) ;; Enable word wrapping
  (column-number-mode 1) ;; Show column number in modeline

  (setq visible-cursor nil) ;; Hide the cursor when inactive
  (blink-cursor-mode 0)  ;; Completely disable cursor blinking

  ;; ----------------------------
  ;; Scrolling & Navigation
  ;; ----------------------------
  (setq scroll-margin 5
        scroll-conservatively 101
        scroll-step 1)

  ;; ----------------------------
  ;; Editing & Interaction
  ;; ----------------------------
  (fset 'yes-or-no-p 'y-or-n-p) ;; Make `y` and `n` confirm instead of `yes` and `no`

  (setq undo-limit 80000000
        undo-strong-limit 120000000) ;; Better undo system

  ;; Adaptive Wrap Mode for better text wrapping
  (use-package adaptive-wrap
    :hook (visual-line-mode . adaptive-wrap-prefix-mode))

  ;; ----------------------------
  ;; Session & Persistence
  ;; ----------------------------
  (desktop-save-mode 1) ;; Save session automatically
#+end_src
** Appearance
*** Color-scheme
#+begin_src emacs-lisp  
  (load-theme 'leuven t)
  ;;(set-face-background 'child-frame-border "#3F444A")
  (set-face-background 'child-frame-border "#335EA8")

  ;; font
  (use-package all-the-icons
  :ensure t)
  (use-package emacs-emojify)
  (require 'all-the-icons)
  (require 'ucs-normalize)

  (set-face-attribute 'default nil :font "GoMono Nerd Font-20")
  (set-face-attribute 'variable-pitch nil :font "GoMono Nerd Font-20")

  (when (member "Noto Color Emoji" (font-family-list))
  (set-fontset-font t 'emoji (font-spec :family "Noto Color Emoji") nil 'prepend)
  (set-fontset-font t 'symbol (font-spec :family "Noto Color Emoji") nil 'prepend))
#+end_src
*** bars
#+begin_src emacs-lisp
  (use-package doom-modeline
  :straight t
  :hook (after-init . doom-modeline-mode)
  :custom
  (doom-modeline-height 25)
  (doom-modeline-enable-word-count t)
  (doom-modeline-buffer-file-name-style 'truncate-upto-root)
  (doom-modeline-icon t)
  (doom-modeline-major-mode-icon t)
  (doom-modeline-modal-icon t))

#+end_src
* Org
** General settings
#+begin_src emacs-lisp
  (setq package--init-file-ensured t) ;; Workaround for package.el trying to autoload
  (setq load-prefer-newer t) ;; Always prefer newer built-in files
  (setq org-modules nil) ;; Don't autoload extra Org modules
  ;; (add-hook 'org-mode-hook #'hide-mode-line-mode) ;; disable status line in org mode TODO make it just different

  (setq org-use-property-inheritance t)
  (setq org-startup-indented t)        ;; Pretty indentation
  (setq org-pretty-entities t)         ;; Display symbols (like LaTeX-style)
  (setq org-ellipsis " ▾")             ;; Make collapsible sections look better
  (setq org-hide-leading-stars t)      ;; Hide extra stars in headlines
  (setq org-special-ctrl-a/e t)        ;; More predictable movement in lists
  (setq org-use-speed-commands t)      ;; Speed commands (useful for large org files)
  (add-hook 'org-mode-hook #'visual-line-mode)
  (add-hook 'org-mode-hook #'adaptive-wrap-prefix-mode) ;; Indent wrapped lines nicely

  (setq org-startup-with-inline-images t) ;; Show images when opening an Org file
  (setq org-image-actual-width nil)       ;; Scale images to their actual width

  ;; Enable persistent todo states tracking
  (setq org-log-done 'time)
  (setq org-log-into-drawer t)  ;; Store logs in a drawer for a cleaner view
  ;; bullets instead of asteriks
  ;; (add-hook 'org-mode-hook 'org-indent-mode)

  (custom-set-faces
   '(org-level-1 ((t (:inherit outline-1 :height 1.3))))  ;; Largest
   '(org-level-2 ((t (:inherit outline-2 :height 1.2))))
   '(org-level-3 ((t (:inherit outline-3 :height 1.1))))
   '(org-level-4 ((t (:inherit outline-4 :height 1.0))))
   '(org-level-5 ((t (:inherit outline-5 :height 1.0))))
   '(org-level-6 ((t (:inherit outline-6 :height 1.0))))
   '(org-level-7 ((t (:inherit outline-7 :height 1.0))))
   '(org-level-8 ((t (:inherit outline-8 :height 1.0)))))

  (use-package org-superstar
    :hook (org-mode . org-superstar-mode)
    :config
    (setq org-superstar-headline-bullets-list '(" " "◉" "●" "󰧂" "󰘍")
          org-superstar-item-bullet-alist '((?* . ?•) (?+ . ?•) (?- . ?➤))))
#+end_src
** Plugins
#+begin_src emacs-lisp
  ;; dictionary
  (use-package flyspell
    :hook (org-mode . flyspell-mode)  ;; Enable spell checking in Org mode
    :config
    (setq ispell-program-name "aspell") ;; Use Aspell (or set it to "hunspell" if you prefer)
    (setq ispell-extra-args '("--sug-mode=ultra")) ;; Faster suggestions
    (setq flyspell-issue-message-flag nil)) ;; Prevent annoying messages

  ;; integration with vertigo
  (use-package flyspell-correct
  :after flyspell
  :bind (:map flyspell-mode-map ("C-;" . flyspell-correct-wrapper)))

  ;; Napking integration
(use-package ob-napkin
  :ensure t
  :after org
  :config
  (add-to-list 'org-babel-load-languages '(napkin . t))) ;; Adjust path if using pipx
#+end_src
** Custom funcs
#+begin_src emacs-lisp
(defun my/org-meta-return-no-split ()
  "Insert a new heading/item without splitting the current line."
  (interactive)
  (end-of-line)  ;; Move to the end of the line
  (org-meta-return))  ;; Then create a new item

(defun my/fix-all-spelling-mistakes ()
  "Iterate over all spelling mistakes in the buffer and correct them interactively."
  (interactive)
  (goto-char (point-min))  ;; Start from the beginning of the buffer
  (while (progn
           (flyspell-goto-next-error)  ;; Jump to next mistake
           (if (not (eobp))  ;; If we're not at the end, correct it
               (progn
                 (ispell-word)  ;; Open interactive correction (z=)
                 t)  ;; Continue looping
             nil))))  ;; Stop at the end of the buffer
;; (defun my/flyspell-correct ()
;;   "Use Consult to choose spelling corrections in a fuzzy-search popup."
;;   (interactive)
;;   (if (not (flyspell-get-word))
;;       (message "No spelling errors!")
;;     (let* ((word (car (flyspell-get-word)))
;;            (corrections (if word (ispell-lookup-words word)))
;;            (selection (consult--read corrections
;;                                      :prompt (format "Fix \"%s\": " word)
;;                                      :sort t)))
;;       (when selection
;;         (flyspell-do-correct 'save selection word
;;                              (point) (flyspell-word))))))


;; Bind it to a key (optional)
(global-set-key (kbd "C-c z") 'my/fix-all-spelling-mistakes)
;; Rebind M-RET in Org Mode
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "M-RET") #'my/org-meta-return-no-split))
#+end_src

** Babel
#+begin_src emacs-lisp

  (org-babel-do-load-languages
   'org-babel-load-languages
   '((python . t)
     (napkin . t)
     (plantuml . t))) ;; Add any other languages you need
#+end_src

#+RESULTS:

* Plugins
** General
*** Evil mode
#+begin_src emacs-lisp
   (setq evil-want-keybinding nil)  ;; Avoid conflicts with evil-collection
   (setq evil-want-C-u-scroll t)    ;; Enable `C-u` for scrolling
   (setq evil-shift-width 4)        ;; Set default indentation width

   (use-package evil
     :config
     (evil-mode 1)
     (setq-default indent-tabs-mode nil) ;; Use spaces instead of tabs
     (setq-default tab-width 4)          ;; Set tab width
     (setq-default evil-shift-width 4)   ;; Match Doom’s default indentation width
   )
   

  (use-package evil-escape
   :after evil
   :config
   (setq-default evil-escape-key-sequence "fj")
   (evil-escape-mode 1))
   

   (use-package evil-org
     :after org
     :hook (org-mode . evil-org-mode)
     :config
     (evil-org-set-key-theme '(navigation insert textobjects additional shift todo heading)))

   (with-eval-after-load 'org
     (require 'org-tempo))  ;; Enable tempo-based expansion

   (use-package evil-collection
     :after evil
     :ensure t
     :config
     (evil-collection-init))

   (use-package evil-snipe)

#+end_src

*** ivy /(inactive)/
#+begin_src emacs-lisp
;; (use-package ivy
;;   :init
;;   (ivy-mode 1)
;;   :bind
;;   (("C-x b" . ivy-switch-buffer) ;; Replace consult-buffer
;;    ("M-x" . counsel-M-x)         ;; Replace vertico's default M-x
;;    ("C-s" . swiper))             ;; Replace consult-line
;;   :config
;;   (setq ivy-use-virtual-buffers t
;;         ivy-count-format "(%d/%d) "
;;         enable-recursive-minibuffers t))
;; 
;; (use-package counsel
;;   :after ivy
;;   :config
;;   (counsel-mode 1))
;; 
;; (use-package swiper
;;   :after ivy
;;   :bind (("C-s" . swiper)))  ;; This replaces consult-line
#+end_src

*** Vertigo
**** Vertigo
#+begin_src emacs-lisp
(use-package vertico
  :init
  (vertico-mode)
  :bind (:map vertico-map
              ("C-j" . vertico-next)
              ("C-k" . vertico-previous)
              ("C-S-j" . vertico-last)
              ("C-S-k" . vertico-first)
              ("M-j" . vertico-scroll-down)
              ("M-k" . vertico-scroll-up))
  :config
  (setq vertico-count 20
        vertico-resize t))

#+end_src

**** Posframe
- [ ] make it not suck
#+begin_src emacs-lisp
    (use-package posframe
      :ensure t)

    (use-package vertico-posframe
      :ensure t
      :after vertico
      :custom
      ;; Position handler
      (vertico-posframe-poshandler 'posframe-poshandler-frame-center)
      (vertico-posframe-border-width 10)
      ;; Optional extra posframe parameters
      (vertico-posframe-parameters
       '((left-fringe . 8)
         (right-fringe . 8)
         ))
      :config
      (vertico-posframe-mode 1))

    (defun my/disable-vertico-posframe ()
    "Disable vertico-posframe for certain commands."
    (when (or 
              (eq this-command 'consult-line)
              (eq this-command 'projectile-grep)
              (eq this-command 'lsp-find-references)
              ;;(eq this-command 'consult-ripgrep)
              ;;(eq this-command 'consult-grep)
              ;;(eq this-command 'project-find-regexp)
              )
      (vertico-posframe-mode -1)))
  
  (defun my/enable-vertico-posframe ()
    "Re-enable vertico-posframe after minibuffer exits."
    (unless vertico-posframe-mode
      (vertico-posframe-mode 1)))

  (add-hook 'minibuffer-setup-hook #'my/disable-vertico-posframe)
  (add-hook 'minibuffer-exit-hook #'my/enable-vertico-posframe)
#+end_src
**** Consult
#+begin_src emacs-lisp
  (use-package consult
     :bind (("C-s" . consult-line)
            ("C-x b" . consult-buffer)
            ("M-g g" . consult-goto-line))
    :config
    (setq consult-project-root-function #'vc-root-dir
      xref-show-xrefs-function #'consult-xref
      xref-show-definitions-function #'consult-xref))
#+end_src
**** Embark
#+begin_src emacs-lisp
(use-package embark
  :ensure t
  :bind
  (("C-." . embark-act)   ;; Act on the current candidate
   ("C-;" . embark-dwim)) ;; Context-sensitive do-what-I-mean
  :init
  (setq prefix-help-command #'embark-prefix-help-command))

(use-package embark-consult
  :ensure t
  :after (embark consult))
#+end_src
**** Marginalia
#+begin_src emacs-lisp
(use-package marginalia
  :config
  (marginalia-mode))
#+end_src
**** Orderless
Using orderless for better fzf searches
#+begin_src emacs-lisp
(use-package orderless
  :straight t
  :custom
  (completion-styles '(orderless basic))
  (completion-category-defaults nil)
  (completion-category-overrides '((file (styles partial-completion)))))
#+end_src
**** Corfu
#+begin_src emacs-lisp
  (use-package corfu
    :straight t
    :custom
    (corfu-auto t)                 ;; Enable auto-completion
    (corfu-cycle t)                ;; Enable cycling through candidates
    (corfu-auto-prefix 1)          ;; Minimum prefix length before auto-complete triggers
    (corfu-auto-delay 0.0)         ;; No delay before suggestions appear
    (corfu-preview-current nil)    ;; Disable inline preview
    (corfu-quit-no-match 'separator) ;; Quit when input does not match
    :init
    (global-corfu-mode)) 

  (use-package corfu-popupinfo
  :straight (:type git :host github :repo "minad/corfu")
  :after corfu
  :init
  (corfu-popupinfo-mode))
#+end_src
*** Popper
To get pop-ups with vterm and eshell
#+begin_src emacs-lisp
(use-package popper
  :ensure t
  :bind (("M-t" . popper-toggle)         ; Toggle the most recent popup.
         ("M-f" . popper-cycle))         ; Cycle through your defined popups.
  :config
  ;; Define which buffers should be treated as popups.
  (setq popper-reference-buffers
        '("^\\*vterm"      ; vterm buffers (or multi-vterm buffers)
          "^\\*ielm\\*"))  ; ielm for Emacs Lisp evaluation.
  (popper-mode +1)
  (popper-echo-mode +1))

(with-eval-after-load 'vterm
  (define-key vterm-mode-map (kbd "M-t") #'popper-toggle)
  (define-key vterm-mode-map (kbd "M-f") #'popper-cycle))
#+end_src
*** Mini-frame
#+begin_src emacs-lisp
;; (use-package mini-frame
;;   :ensure t
;;   :config
;;   (mini-frame-mode t))

;; (defun my/show-messages-in-minibuffer ()
;;   "Display messages temporarily in the minibuffer."
;;   (interactive)
;;   (let ((msg (with-current-buffer "*Messages*"
;;                (buffer-substring-no-properties (point-min) (point-max)))))
;;     (message "%s" msg)))

;; (global-set-key (kbd "C-c m") #'my/show-messages-in-minibuffer)
#+end_src
*** Vterm
is a terminal emulator
- [ ] make ielm keybind
#+begin_src emacs-lisp
(use-package vterm)
(use-package multi-vterm
  :ensure t
  :bind (("C-c t" . multi-vterm)))  ; Use this binding to spawn a new terminal instance.

#+end_src
** LSP
*** tree-sitter
#+begin_src emacs-lisp
  (setq treesit-language-source-alist
        '((bash        "https://github.com/tree-sitter/tree-sitter-bash")
          (c           "https://github.com/tree-sitter/tree-sitter-c")
          (cpp         "https://github.com/tree-sitter/tree-sitter-cpp")
          (css         "https://github.com/tree-sitter/tree-sitter-css")
          (go          "https://github.com/tree-sitter/tree-sitter-go")
          (html        "https://github.com/tree-sitter/tree-sitter-html")
          (javascript  "https://github.com/tree-sitter/tree-sitter-javascript" "master" "tree-sitter-javascript/src")
          (json        "https://github.com/tree-sitter/tree-sitter-json")
          (lua         "https://github.com/Azganoth/tree-sitter-lua")
          (make        "https://github.com/alemuller/tree-sitter-make")
          (markdown    "https://github.com/ikatyang/tree-sitter-markdown")
          (python      "https://github.com/tree-sitter/tree-sitter-python")
          (rust        "https://github.com/tree-sitter/tree-sitter-rust")
          (toml        "https://github.com/tree-sitter/tree-sitter-toml")
          (typescript  "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (tsx         "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
          (yaml        "https://github.com/ikatyang/tree-sitter-yaml")))

  (defun my/treesit-install-all-languages ()
  "Install all Tree-sitter languages listed in `treesit-language-source-alist`."
  (interactive)
  (dolist (lang (mapcar #'car treesit-language-source-alist))
    (unless (treesit-language-available-p lang)
      (treesit-install-language-grammar lang))))

  (setq major-mode-remap-alist
      '((python-mode . python-ts-mode)
        (js-mode . js-ts-mode)
        (c-mode . c-ts-mode)
        (c++-mode . c++-ts-mode)
        ;; and so on...
        ))
  
(use-package treesit-fold
  :straight (treesit-fold
             :type git
             :host github
             :repo "emacs-tree-sitter/treesit-fold")
  :hook ((c-ts-mode . treesit-fold-mode)
         (c++-ts-mode . treesit-fold-mode)))
#+end_src
**** c++ rules
#+begin_src emacs-lisp
;;   (defun my/treesit-fold-c++-setup ()
;;   "Customize treesit-fold for C++ to fold function bodies and initializer lists."
;;   (setq-local treesit-fold-rules
;;               (treesit-fold-rules-create
;;                (function_definition)    ;; Folds function bodies
;;                (initializer_list)       ;; Folds initializer lists
;;                (compound_statement)     ;; Folds any `{ ... }` blocks
;;                )))
;; 
;; (add-hook 'c++-ts-mode-hook #'my/treesit-fold-c++-setup)
#+end_src

*** lsp-mode
**** setting up lsp
basic lsp setup using lsp-mode
#+begin_src emacs-lisp
  (use-package lsp-mode
    :ensure t
    :commands (lsp lsp-deferred)
    :init
    (setq lsp-keymap-prefix "C-c l"      ;; Prefix for LSP commands
          lsp-auto-configure t           ;; Auto-detect root directory
          lsp-enable-snippet nil         ;; Disable snippet support
          lsp-session-file "~/.emacs.d/lsp-session-v1" ;; Store session
          lsp-prefer-flymake t           ;; Use `flycheck` instead of `flymake`
          lsp-idle-delay 0.2             ;; Reduce delay for better responsiveness
          lsp-log-io nil                 ;; Disable verbose logging unless debugging
          lsp-enable-symbol-highlighting t) ;; Highlight symbol occurrences

    :hook ((prog-mode . lsp)
           (c-ts-mode . lsp)
           (c++-ts-mode . lsp)
           (java-mode . lsp)
           (python-mode . lsp))
    
    :config
    (setq lsp-auto-guess-root t)  ;; Ensure LSP picks the correct root directory
    (setq xref-search-program 'ripgrep) ;; Use ripgrep for faster searches
    (setq xref-backend-functions '(lsp--xref-backend))) ;; Ensure xref uses LSP
  (add-hook 'lsp-mode-hook #'flymake-mode)

#+end_src
**** Inline diagnostics
#+begin_src emacs-lisp
;; (use-package flymake-inline
;;   :ensure t
;;   :hook (flymake-mode . flymake-inline-mode)
;;   :config
;;   ;; You can tweak the face used for the inline text, e.g. a subtle color:
;;   ;;(set-face-attribute 'flymake-inline-error nil :foreground "red" :background "gray20" :height 0.9)
;; 
;;   ;; Optionally, only show errors (not warnings/notes):
;;   ;; (setq flymake-inline-errors-only t)
;; )
#+end_src
**** lsp keymaps
#+begin_src emacs-lisp
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j"
   :command nil ;; prefix
   :desc "lsp commands")

  ;; clang magic
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j h"
   :command 'lsp-clangd-find-other-file 
   :desc "[h]eader-impl switch")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j l"
   :command 'lsp-find-references 
   :desc "find [l]inks(refs)")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j r"
   :command 'lsp-rename
   :desc "smart [r]ename")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j s"
   :command 'lsp-find-declaration 
   :desc "goto [s]ignature")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j d"
   :command 'lsp-find-definition 
   :desc "goto [d]efinition")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j m"
   :command 'lsp-find-implementation
   :desc "goto i[m]plementation")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j w"
   :command 'lsp-ui-doc-toggle 
   :desc "toggle help")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j t"
   :command 'lsp-find-type-definition 
   :desc "[t]ype definiton")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j c"
   :command 'consult-flymake 
   :desc "[c]onsult flymake (diag.)")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j p"
   :command 'flymake-show-project-diagnostics 
   :desc "flymake of the [p]roject")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j b"
   :command 'flymake-show-buffer-diagnostics 
   :desc "flymake of the [b]uffer")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j j"
   :command 'flymake-goto-next-error 
   :desc "flymake next")
  
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC j k"
   :command 'flymake-goto-prev-error 
   :desc "flymake prev")


#+end_src

**** clangd configuration
#+begin_src emacs-lisp
  (setq lsp-clients-clangd-executable "/usr/bin/clangd"
          lsp-clients-clangd-args
          '("--background-index"
            "--pch-storage=memory"
            "--clang-tidy"
            "--suggest-missing-includes"
            "--header-insertion=iwyu"
            "--index-file=global"
            "--compile-commands-dir=build"))
  
(add-to-list 'auto-mode-alist '("\\.cppm\\'" . c++-ts-mode))
  (use-package flycheck-clang-tidy
    :ensure t
    :after flycheck
    :config
    (flycheck-clang-tidy-setup))

      ;; TODO: setup a dir for compile-commands (read from file-specific conf file for the project)
      ;; TODO: my/get-clangd-compile-commands-die
      ;; (setq lsp-clients-clangd-args
      ;;       (append lsp-clients-clangd-args
      ;;               (list (concat "--compile-commands-dir=" (my/get-clangd-compile-commands-dir))))))


#+end_src

#+RESULTS:
: t

**** custom lsp functions
#+begin_src emacs-lisp
   (defun my/display-xref-in-bottom-window (buffer alist)
     "Display `xref` results in a bottom split window."
     (let ((window (display-buffer buffer
                                   '(display-buffer-reuse-window
                                     display-buffer-in-side-window)
                                   '((side . bottom)
                                     (slot . 0)
                                     (window-height . 0.3)))))
       (select-window window)
       window))

  
  ;; (setq xref-show-xrefs-function #'my/display-xref-in-bottom-window
  ;;    xref-show-definitions-function #'my/display-xref-in-bottom-window)
  
    ;;   (defun consult-lsp-code-actions ()
    ;;   "Show LSP code actions using `consult' for a better UI."
    ;;   (interactive)
    ;;   (let* ((actions (lsp-code-actions-at-point))
    ;;          (titles (mapcar (lambda (action)
    ;;                            (alist-get 'title action))
    ;;                          actions)))
    ;;     (if actions
    ;;         (let* ((selected-action (consult--read titles :prompt "Code Action: ")))
    ;;           (when selected-action
    ;;             (lsp-execute-code-action
    ;;              (seq-find (lambda (action)
    ;;                          (string= (alist-get 'title action) selected-action))
    ;;                        actions))))
    ;;       (message "No code actions available"))))
    ;; 
    ;; ;; Bind to a key
    ;; (global-set-key (kbd "C-c l a") #'consult-lsp-code-actions)


#+end_src
*** lsp-ui
#+begin_src emacs-lisp
;; LSP UI enhancements
(use-package lsp-ui
  :ensure t
  :after lsp-mode
  :commands lsp-ui-mode
  :config
  (setq lsp-ui-doc-enable t          ; Enable documentation on hover
        lsp-ui-doc-position 'at-point ; Show docs at point
        lsp-ui-sideline-enable t     ; Enable sideline diagnostics
        lsp-ui-peek-enable t))       ; Enable peek definitions
#+end_src

*** Setting up LSP:
I use mason-installed servers here
#+begin_src emacs-lisp
(setq lsp-clients-python-library-directories '("~/.local/share/nvim/mason/bin/"))
(setq lsp-clients-jdtls-executable "~/.local/share/nvim/mason/bin/jdtls")
#+end_src

*** company-mode
#+begin_src emacs-lisp
;; (use-package company
;;   :hook (prog-mode . company-mode)
;;   :config
;;   (setq company-idle-delay 0.2
;;         company-minimum-prefix-length 1))
;; 
;; ;; If you're on lsp-mode 8.x or newer:
;; (use-package lsp-mode
;;   :hook ((c-ts-mode . lsp)
;;          (c++-ts-mode . lsp))
;;   :config
;;   ;; lsp-mode can automatically integrate with company:
;;   (setq lsp-completion-provider :capf))
#+end_src

*** Projectile
#+begin_src emacs-lisp
;; Project Management (Doom-like)
(use-package projectile
  :ensure t
  :init
  (setq projectile-project-search-path '("~/projects/" "~/dev/"))
  (projectile-mode +1)
  :bind-keymap
  ("C-c p" . projectile-command-map))
#+end_src
** UI
*** Which-Key
#+begin_src emacs-lisp
  (use-package which-key
    :ensure t
    :init
    (which-key-mode 1) ;; Enable Which-Key globally
    :config
    (setq which-key-side-window-location 'bottom
          which-key-sort-order #'which-key-key-order-alpha
          which-key-allow-imprecise-window-fit nil
          which-key-sort-uppercase-first nil
          which-key-add-column-padding 1
          which-key-max-display-columns nil
          which-key-min-display-lines 10
          which-key-side-window-slot -10
          which-key-side-window-max-height 0.25
          which-key-idle-delay 0.01
          which-key-max-description-length 25
          which-key-separator " → "))
#+end_src

#+RESULTS:
: t

** "Tmux-like" workflow
to have sessions + windows of tmux
#+begin_src emacs-lisp
(define-prefix-command 'my-tmux-map)
(keymap-set global-map "C-n" 'my-tmux-map)

(setq tab-bar-mode nil) ;; Disable global tab-bar-mode
;; (add-hook 'persp-switch-hook #'tab-bar-mode) ;; Enable tabs only inside a workspace
#+end_src
*** Eyebrowse
**** desc
- Lets you switch between multiple window configurations.
- Works similarly to tmux "windows" within a session.
- Allows renaming, quick switching, and numbered navigation.
- Supports fzf search via integration with consult.
- Tabs inside a workspace (like tmux windows)
**** plugin
#+begin_src emacs-lisp
(use-package eyebrowse
  :init
  (eyebrowse-mode t)
  :config
  (setq eyebrowse-new-workspace t)  ;; Always create new empty workspaces
  (setq eyebrowse-wrap-around t)    ;; Cycle when reaching the end
  (setq eyebrowse-mode-line-separator " | ")
  (setq eyebrowse-mode-line-style 'always)
  (setq eyebrowse-keymap-prefix (kbd "C-c w"))) ;; TODO

;; Keybindings for Eyebrowse under C-n
(keymap-set my-tmux-map "k" #'eyebrowse-prev-window-config)
(keymap-set my-tmux-map "j" #'eyebrowse-next-window-config)
(keymap-set my-tmux-map "e" #'eyebrowse-last-window-config)
(keymap-set my-tmux-map "r" #'eyebrowse-rename-window-config)
#+end_src
*** Perspective.el
**** desc
- Each "perspective" is an isolated workspace.
- Buffers, window configurations, and layouts are separated.
- You can quickly switch, rename, create, and delete perspectives.
**** perspective.el
#+begin_src emacs-lisp
  (use-package perspective
    :bind
    ("C-x C-b" . persp-list-buffers)
    :custom
    (persp-mode-prefix-key (kbd "C-c n")) 
    (persp-suppress-no-prefix-key-warning t)
    (persp-state-default-file "~/.emacs.d/perspective-session")
    :init
    (persp-mode)) ;; Load the session on startup


  ;; Use lambdas to pass the file path argument
  (add-hook 'emacs-startup-hook
            (lambda () (persp-state-load persp-state-default-file)))
  
  (add-hook 'kill-emacs-hook
            (lambda () (persp-state-save persp-state-default-file)))

  ;; TODO
  ;; Integrates perspective.el with consult for fuzzy workspace search.
  ;; (use-package consult-persp
  ;;   :after (consult perspective)
  ;;   :bind ("C-x C-p" . consult-persp)) ;; Search and switch workspaces

  ;; (keymap-set my-tmux-map "q" #'persp-kill-buffer*)
  ;; (keymap-set my-tmux-map "b" #'persp-switch-to-buffer*)
  ;; (keymap-set my-tmux-map "C-b" #'persp-list-buffers)
  ;; (keymap-set my-tmux-map "K" #'persp-switch)
  ;; (keymap-set my-tmux-map "J" #'persp-next)
  ;; (keymap-set my-tmux-map "n" #'persp-switch)  ;; Switch workspace
  ;; (keymap-set my-tmux-map "R" #'persp-rename)  ;; Rename workspace
  ;; (keymap-set my-tmux-map "d" #'persp-kill)    ;; Kill workspace
#+end_src

*** Tab-Spaces
#+begin_src emacs-lisp
(use-package tabspaces
  :hook (after-init . tabspaces-mode)
  :config
  (setq tabspaces-use-filtered-buffers-as-default t)
  (setq tabspaces-default-tab "default")
  (setq tabspaces-remove-to-default t)
  (setq tabspaces-include-buffers '("*scratch*")))

(keymap-set my-tmux-map "s" #'tabspaces-switch-or-create-workspace)
(keymap-set my-tmux-map "o" #'tabspaces-next-or-new)
(keymap-set my-tmux-map "O" #'tabspaces-previous)
#+end_src
*** Projectile
#+begin_src emacs-lisp
(use-package projectile
  :ensure t
  :init
  ;; The directories Projectile will check recursively for projects
  ;; (particularly if you do “M-x projectile-discover-projects-in-search-path”)
  (setq projectile-project-search-path '("~/_progs" "~/_projects"))

  :config
  (projectile-mode +1)

  ;; Optional: Integrate with your completion framework (e.g., vertico or ivy)
  (setq projectile-completion-system 'default) ;; or 'ivy, 'helm, etc.

  ;; Optional: Keymap for common Projectile commands
  :bind-keymap
  ("C-c p" . projectile-command-map))
#+end_src
*** Tmux emulation
**** desc
- /perspective/ manages "workspaces"
- each workspace is associated with one /projectile/ project
  + [ ] before persp switch hook: save current window layouts in a file
  + [ ] after persp switch hook: load window layout for this persp
  + [ ] on delete of persp hook: delete associated win layout file
- each perspective has its own tabs
  + usually main + git + terminal tab
- in each workplaces there is separate list of eyebrowse buffer layouts
  + [ ] after the window layout is saved, create/switch to a draft buffer
**** code
#+begin_src emacs-lisp
  ;; ;; save eyebrowse session every time before switching perspectives  
  ;; (defun my-persp-before-switch-hook ()
  ;;     "Store eyebrowse state before switching perspectives."
  ;;      (when (bound-and-true-p eyebrowse-mode)
  ;;          (persp-set-local "eyebrowse-last-slot" eyebrowse-last-slot)
  ;;          (persp-set-local "eyebrowse-window-configs" eyebrowse-window-configs))) 

  ;;  ;; and restore after
  ;;  (defun my-persp-switch-hook ()
  ;;      "Restore eyebrowse state after switching perspectives."
  ;;           (when (bound-and-true-p eyebrowse-mode)
  ;;               (setq eyebrowse-last-slot (or (persp-get-local "eyebrowse-last-slot") 1))
  ;;               (setq eyebrowse-window-configs (or (persp-get-local "eyebrowse-window-configs") nil))
  ;;               (eyebrowse-mode 1))) ;; Ensure eyebrowse is enabled

  ;;  ;; and also create win layout for every session start
  ;; (defun my-persp-create-eyebrowse ()
  ;;     "Create a new eyebrowse window configuration when a new perspective is created."
  ;;     (when (bound-and-true-p eyebrowse-mode)
  ;;         (eyebrowse-create-window-config)
  ;;         (message "Created a new eyebrowse workspace for the perspective.")))
  ;; 
  ;; + save + load it on emacs exit
  ;; (defun my-save-session ()
  ;;     "Save both `perspective.el` and `eyebrowse` sessions."
  ;;     (interactive)
  ;;     (persp-state-save persp-state-default-file)
  ;;     (message "Workspace and window configurations saved.")) 
  ;; (defun my-load-session ()
  ;;     "Load both `perspective.el` and `eyebrowse` sessions."
  ;;      (interactive)
  ;;      (persp-state-load persp-state-default-file)
  ;;      (eyebrowse-mode 1)
  ;;      (message "Workspace and window configurations restored."))

   ;; hooking together
  ;; (add-hook 'persp-before-switch-functions #'my-persp-before-switch-hook)
  ;; (add-hook 'persp-switch-functions #'my-persp-switch-hook)
  ;; (add-hook 'persp-created-hook #'my-persp-create-eyebrowse)
  
  ;; (add-hook 'kill-emacs-hook #'my-save-session)
  ;; (add-hook 'after-init-hook #'my-load-session)

#+end_src

** Some Random Apps
*** Telega.el
#+begin_src emacs-lisp
  (use-package telega)
  (setq telega-emoji-use-images t) ;; Use images for better emoji rendering
  (setq telega-emoji-font-family "Noto Color Emoji") ;; Force emoji font usage

#+end_src
*** PDF Reader
#+begin_src emacs-lisp
(use-package pdf-tools
  :ensure t
  :config
  (pdf-tools-install) ;; Install PDF handling tools
  (setq-default pdf-view-display-size 'fit-page)
  (define-key pdf-view-mode-map (kbd "C-s") 'isearch-forward)) ;; Enable search
#+end_src
* Keymaps
** Get completion for plugins commands
#+begin_src emacs-lisp
  (defun my/exec-with-prefix (prefix)
  (interactive)
    (minibuffer-with-setup-hook
        (lambda () (insert prefix))
      (command-execute #'execute-extended-command)))
    
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC t"
   :command nil ;; prefix
   :desc "get completions")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC t c"
   :command (lambda () (interactive) (my/exec-with-prefix "projectile- "))
   :desc "consult commands")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC t p"
   :command (lambda () (interactive) (my/exec-with-prefix "projectile- "))
   :desc "projectile commands")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC t e"
   :command (lambda () (interactive) (my/exec-with-prefix "eyebrowse- "))
   :desc "eyebrowse commands")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC t d"
   :command (lambda () (interactive) (my/exec-with-prefix "dired- "))
   :desc "dired commands")
  
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC t l"
   :command (lambda () (interactive) (my/exec-with-prefix "lsp- "))
   :desc "lsp commands")

#+end_src

#+RESULTS:

** TODO Buffer/Project Navigation
#+begin_src emacs-lisp
  ;; TODO:  probably that will be needed to count only for "pesp-session" buffer
  (keymap-set evil-normal-state-map "C-O" 'previous-buffer) 
  (keymap-set evil-normal-state-map "C-I" 'next-buffer)

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC f"
   :command nil ;; prefix
   :desc "search")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC f f"
   :command 'projectile-find-file
   :desc "projectile-find-file")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC f j"
   :command 'consult-project-buffer
   :desc "consult-project-buffer")  

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC f s"
   :command 'projectile-grep
   :desc "projectile grep")  

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC f s"
   :command 'projectile-grep
   :desc "projectile grep")  

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC f m"
   :command 'imenu
   :desc "imenu")
  
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC f e"
   :command 'projectile-dired
   :desc "imenu")

  ;; TODO compile errors
   

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "C-n"
   :command nil ;; prefix
   :desc "perspectives")
  (keymap-set evil-normal-state-map "C-n" (make-sparse-keymap))

  ;; perspective
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "C-n C-n"
   :command 'persp-switch
   :desc "pesps switch")  

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "C-n C-e"
   :command 'persp-switch-last
   :desc "pesps switch last")

  ;; evil-snipe
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "f"
   :command 'evil-snipe-f
   :desc "evil-snipe-f")  

#+end_src

#+RESULTS:

** Quick access files
#+begin_src emacs-lisp
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC F"
   :command nil ;; prefix
   :desc "open files")

  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC F d"
   :command nil ;; prefix
   :desc "dotfiles")
  
  (keymap-set-with-desc
   :map evil-normal-state-map
   :key "SPC F d e"
   :command (lambda () (interactive) (find-file "~/.config/emacs/config.org"))
   :desc "emacs/config.org")

#+end_src
** Evil-insert
#+begin_src emacs-lisp
  (keymap-set-with-desc
   :map evil-insert-state-map
   :key "C-a"
   :command 'move-beggining-of-line
   :desc "beggining of the line")
#+end_src

* Custom Functions
** Show Messages in a slide-buffer
#+begin_src emacs-lisp
  (add-to-list 'display-buffer-alist
             '("\\*projectile-files-errors\\*"
               (display-buffer-in-side-window)
               (side . bottom)
               (window-height . 0.3)
               (window-parameters . ((no-other-window . nil)
                                     (no-delete-other-windows . nil)))))
  (add-to-list 'display-buffer-alist
             '("\\*compilation\\*"
               (display-buffer-in-side-window)
               (side . bottom)
               (window-height . 0.3)
               (window-parameters . ((no-other-window . nil)
                                     (no-delete-other-windows . nil)))))

  (defun my/toggle-messages-window ()
  "Toggle the *Messages* buffer in a selectable bottom window."
  (interactive)
  (let ((buffer (get-buffer "*Messages*")))
    (if (and buffer (get-buffer-window buffer))
        (delete-window (get-buffer-window buffer))  ;; Close if open
      (display-buffer buffer
                      '((display-buffer-in-side-window)
                        (side . bottom)
                        (window-height . 0.3)
                        (window-parameters . ((no-other-window . nil) ;; Allow selection
                                              (no-delete-other-windows . nil))))))))

    (global-set-key (kbd "C-c m") #'my/toggle-messages-window)
#+end_src

#+RESULTS:
: my/toggle-messages-window

** Working with floating windows
#+begin_src emacs-lisp
(add-to-list 'load-path "~/.config/emacs/")
(require 'elastic)
(global-set-key (kbd "C-c t") 'elastic-vterm)
#+end_src
** Disable highlights:
#+begin_src emacs-lisp
(defun my-highlight-only-comments ()
  "Enable syntax highlighting only for comments."
  (setq font-lock-defaults
        '((nil t) ;; Disable normal syntax highlighting
          nil nil nil
          (font-lock-comment-face . font-lock-keyword-face)))
  (font-lock-refresh-defaults))
#+end_src

