;;; elastic

;; TODO: recalc work incorrecly
;; TODO: borders are not shown
;; TODO: el-vterm: has exit confirmation

(defvar floating-frame--parent (selected-frame)
  "The parent frame whose geometry is used as reference for floating frames.")

(defvar floating-frame--parent-geometry
  (list :width (frame-pixel-width floating-frame--parent)
        :height (frame-pixel-height floating-frame--parent))
  "A plist storing the current pixel geometry of `floating-frame--parent'.
The keys are :width and :height.")

(defun floating-frame--update-geometry (frame)
  "Update the stored geometry for FRAME if it is the parent frame.
This function is meant to be used in `after-change-frame-geometry-hook'."
  (when (eq frame floating-frame--parent)
    (setq floating-frame--parent-geometry
          (list :width (frame-pixel-width frame)
                :height (frame-pixel-height frame)))))

;; Add our update function to the frame geometry hook.
(add-hook 'after-change-frame-geometry-hook #'floating-frame--update-geometry)

;;;###autoload
(defun elastic-vterm ()
  "Launch a vterm in a new floating child frame.
The new frame's dimensions are computed as 70% of the parent frame's size,
with an offset of 15% from the parent's left and top edges."
  (interactive)
  (let* ((parent floating-frame--parent)
         (geometry floating-frame--parent-geometry)
         (parent-width (plist-get geometry :width))
         (parent-height (plist-get geometry :height))
         ;; Calculate the desired child frame dimensions in pixels.
         (child-width-pixels (* 0.7 parent-width))
         (child-height-pixels (* 0.7 parent-height))
         (child-left (round (* 0.15 parent-width)))
         (child-top (round (* 0.15 parent-height)))
         ;; Convert pixels to text dimensions.
         (char-width (frame-char-width parent))
         (char-height (frame-char-height parent))
         (child-width-chars (max 1 (floor (/ child-width-pixels char-width))))
         (child-height-lines (max 1 (floor (/ child-height-pixels char-height))))
         ;; Create the child frame.
         (child-frame (make-frame `((parent-frame . ,parent)
                                     (title . "elastic-vterm")
                                     (left . ,child-left)
                                     (top . ,child-top)
                                     (width . ,child-width-chars)
                                     (height . ,child-height-lines)
                                     (child-frame-border-width . 10)
                                     (visibility . t)
                                     (no-accept-focus . nil)
                                     (undecorated . nil)
                                     (keep-ratio . t)))))
   ;; Focus the new frame.
    (select-frame-set-input-focus child-frame)
    ;; Launch vterm in the new frame if available.
    (when (fboundp 'vterm)
      (let ((vterm-buffer (vterm)))
        (set-window-buffer (frame-root-window child-frame) vterm-buffer)
        ;; Disable the mode-line in the vterm buffer.
        (with-current-buffer vterm-buffer
          (setq-local mode-line-format nil)
          ;; Disable the exit confirmation by clearing the process query flag.
          (when-let ((proc (get-buffer-process (current-buffer))))
            (set-process-query-on-exit-flag proc nil)))
        
        ))))

(provide 'elastic)
